---
- name: Define nginx_user.
  set_fact:
    nginx_user: "{{ __nginx_user }}"
  when: nginx_user is not defined


- name: Enable nginx repo.
  template:
    src: nginx.repo.j2
    dest: /etc/yum.repos.d/nginx.repo
    owner: root
    group: "{{ root_group }}"
    mode: 0644

- name: Ensure nginx is installed.
  package:
    name: "nginx"
    state: present
  
- name: Start nginx
  service:  
    name: nginx
    state: started
    enabled: yes

# - name: Open port 80/443
#   firewalld:
#     zone: public
#     port: 'item'
#     immediate: true
#     permanent: yes
#     state: enabled
  # loop:
  # - 80/tcp
  # - 443/tcp
  # - 22/tcp
  # - 3306/tcp
  # notify: restart firewalld

- name: Copy config file into conf.d
  template:
    src: proxy.j2
    dest: /etc/nginx/conf.d/proxy.conf
    owner: "{{user}}"
    group: "{{group}}"
    mode: 0644
  notify: restart nginx